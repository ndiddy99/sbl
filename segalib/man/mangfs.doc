*******************************************************************************
●readme.doc種別	：各ライブラリ開発説明ファイル
●ファイル記号名称	：MANGFS.DOC
●対象ライブラリ記号名称：gfs
●対象ライブラリ名称	：ファイルシステム
●バージョン		：1.16
●作成者		：M.S.
●作成日		：1994-11-14
●その他のメッセージ	：なし
*******************************************************************************

１．　V1.16において以下の改善・変更をおこないました。
１．１　GFS_Init() は、以下の設定をおこないます。
	CDブロックソフトリセット	しない
	サブコードデコード		しない
	モード2サブヘッダ認識		する
	フォーム2リードリトライ		しない
	CD-ROMデータリード		倍速
	スタンバイタイム		デフォルト(180秒)
	ECC回数				5回
	リトライ回数			15回

１．２　リードエラー発生時のリカバリ処理の追加
　GFS_NwExecOne, GFS_NwExecServerにおいてリードエラーが発生した場合、V1.15以前と
　同様にGFS_ERR_CDRDを返しますが、そのまま前記の関数を呼ぶとリカバリ処理を実行し
　ます。完了復帰型アクセスでは、V1.15以前と同様にGFS_ERR_CDRDを返します。

１．３　GFS_Freadにおけるタイムアウト時間の延長
　GFS_Fread呼び出し後、データの読み込みが始まるまでのタイムアウト時間を延長しま
　した。

１．４　エラーコードを以下のように変更しました。
　GFS_Loadにおけるシーク位置不正			GFS_ERR_OFS
　GFS_Seekにおけるファイル範囲外へのシーク		GFS_ERR_SEEK
　GFS_NwFread, GFS_Fread再生セクタ数のマイナス指定	GFS_ERR_PARA


２．　補足説明
２．１　DOSファイルのパラメータ
　DOSファイルの取り出しパラメータは１が初期値になっています。処理の都合上、１度
に１セクタしか転送できないため、取り出しパラメータを１以外の値に設定しても無効
です。


３．V1.10からV1.11への変更点
３．１　SCU-DMA使用時の注意
　転送モードがGFS_TMODE_SCUのとき、ファイルシステムライブラリは、DMAライブラリ
を用いてSCU-DMAを起動します。使用するレベルは０です。
　そのためGFS_Initでは、INT_ChgMskによりSCU-DMAレベル０割り込みをイネーブルに
しています。
　転送モードGFS_TMODE_SCUを使用する際はDMAライブラリのドキュメントも参照してく
ださい。


４．　V1.01からV1.10への変更点
４．１　ＣＤ先読み処理の変更
●GFS_NwCdReadの使用法変更
　GFS_NwCdReadを呼び出した後、GFS_NwExecOneが完了する前にGFS_NwFreadを呼び出し
てもＣＤからの先読みは有効になります。
　ＣＤからの先読みを使用すると、指定したセクタ数をすべてホスト側に転送するか、
アクセスを中止させるまで完了しなくなりました。（GFS_NwIsCompleteがTRUEを返さな
い。）

●アクセス完了チェック【重要】
　GFS_NwCdReadを呼び出した場合、データ転送が終わるかアクセスが中止されるまで
GFS_NwExecOneは完了を返しません。GFS_NwFreadを呼び出さずにGFS_NwExecOneが完了
を返すのを待ってはいけません。Rel.2のマニュアルP.18の例のようにGFS_NwCdReadの
直後にGFS_NwExecOneの完了を待つと無限ループになるので注意してください。
　GFS_NwCdReadを呼び出していなければ前バージョンと同じ手順でGFS_NwExecOneの完
了をチェックできます。
　ＣＤからの先読みをしているときには、GFS_NwGetStatを使って転送済みバイトを監
視することも同時に行って完了をチェックしてください。以下に例を示します。
	#define RD_UNIT	10
	GfsHn	gfs;
	Sint32 fid, stat, nbyte;
	Uint32 buf[RD_UNIT*2048/4];

	gfs = GFS_Open(fid);
	GFS_NwCdRead(gfs, 100);
	for (i = 0; i < 100/RD_UNIT; ++i) {
	    GFS_NwFread(gfs, RD_UNIT, buf, RD_UNIT*2048);
	    while (GFS_NwExecOne(gfs) != GFS_SVR_COMPLETED) {
		GFS_NwGetStat(gfs, &stat, &nbyte);
		/* GFS_NwFreadで指定したバイト数が読み込まれたかを調べる */
		if (nbyte >= RD_UNIT*2048) {
		    break;
		}
		user(); 		/* アプリケーション処理 */
	    }
	}


４．２　CD-DAファイル処理機能追加
　CD-DAファイル処理機能を追加しました。CD-DAファイルの読み込みは、そのファイル
で指定される音楽トラックの再生となります。ただし、音を出力させるにはアプリケー
ション側でSCSPを設定する必要があります。
●ファイルに対する制御制御
　CD-DAファイルに対してファイルシステムが行う制御は再生と再生範囲の制御だけで
す。再生モードは省略値（リピートなし、ピックアップを移動する）です。

●再生の仕方
　CD-DAファイルを再生するには次の方法があります。
    (1) GFS_Load
    (2) GFS_Fread
    (3) GFS_NwFread
    (4) GFS_NwCdRead
  (1), (2)の方法では再生が終了するまで戻ってきません。
　(3), (4)の方法ではサーバ関数を呼び出す必要があります。CD-DAの再生が終了する
と、サーバ関数はGFS_SVR_COMPLETEDを返します。
　途中から再生するにはGFS_Seekを使用します。
　CD-DAファイルとCD-ROMファイルを同時にアクセスすることはできません。

●ファイル操作に関するパラメータ
　CD-DAファイルに対して、取り出しモード、転送モード、読み込みパラメータ、
取り出しパラメータを変更することはできません。CD-DAファイルに対して次の関
数を呼び出すとエラーを返します。
	GFS_SetGmode
	GFS_SetTmode
	GFS_SetReadPara
	GFS_SetTransPara


４．３　ファイル属性
　GFS_GetFileInfoで出力されるファイル属性の値をCD-ROM XA規格に準拠させるため、
次のように変更しました。
	GFS_ATR_DIR	0x80
	GFS_ATR_CDDA	0x40
	GFS_ATR_INTLV	0x20
	GFS_ATR_FORM2	0x10
	GFS_ATR_FORM1	0x80
	GFS_ATR_END_TBL 0x01
　GFS_ATR_CDDAはCD-DAファイル処理機能追加のため追加しました。そのビットはCD-DA
ファイルの時1になります。
　その他の定数名とその意味は変わっていません。


４．４　GFS_InitとGFS_LoadDirの関数値
　引数のディレクトリ情報管理構造体へのポインタにNULLを指定すると、ＣＤブロック
ファイルシステムが保持しているディレクトリ情報の個数を関数値として返します。


４．５　エラーコード追加
　次のエラーコードを追加しました。
●GFS_ERR_BFUL
　常駐モード（GFS_GMODE_RESIDENT）のファイルを読み込み中にＣＤバッファがいっぱ
いになると、このエラーコードが発生します。
　常駐モードのファイルアクセス中にはバッファフルにならないようにアクセスの順序
などを調整してください。

●GFS_ERR_FATAL
　このエラーコードはＣＤドライブがFATAL状態になったことを通知します。
　ファイルシステムはこの状態を検出すると、ＣＤ再生を中止（ホーム位置へシーク）
させ、エラー状態からの回復を試みます。このエラーコードを検出したら、処理をリト
ライしてください。


４．６　トレイオープン状態の認識
　ＣＤブロックの割り込み要因レジスタ(HIRQREQ)のDCHGビット(bit5)が1の時も、トレ
イが開いている状態として扱うようにしました。
　開発中は、GFS_Initを呼ぶ前にＣＤステータスがオープンでないことを確認してDCHG
ビットをクリアする処理を行ってください。
　製品版では、BOOT ROMがDCHGフラグをクリアするのでアプリケーションがクリアして
はいけません。


４．７　転送先アドレスによる転送モードの変更
　転送モードがGFS_TMODE_SCUに設定されていても、転送先アドレスが次の空間に含ま
れる場合はCPUによるソフトウェア転送が強制的に行われます。
	WORKRAM-L空間	00200000H 〜 002FFFFFH
	A-BUS空間	02000000H 〜 058FFFFFH


４．８　デバッグファイル関連
●GFMC_base
　SIMMファイルの先頭アドレスを設定する変数GFMC_baseは、sega_gfs.libとsegadgfs.
libの両方に定義しました。
　sega_gfs.lib中のGFMC_baseは、segadgfs.libとの互換性のためだけに存在します。フ
ァイルシステムの動作には影響を与えません。

●ファイル識別子
　ＣＤファイルを使用しないときに"."と".."（カレントディレクトリと親ディレクト
リ）を自動的に追加するという機能を削除しました。これにより、ファイル識別子はブ
ート時と一致します。


５．　バグ修正情報
５．１　V1.11からV1.13への修正
　(1) 再生中にＣＤバッファがいっぱいになるとリードエラー(GFS_ERR_CDRD)になる障害
　　　を修正しました。

５．２　V1.13からV1.15への修正
　(1) 無用なタイムアウトエラー（GFS_ERR_TMOUT）がでる障害を修正しました。

５．３　V1.15からV1.16への修正
　(1) GFS_TMODE_SCUを使用してＢバスに転送する際、１ワード飛びに転送される障害を
　　　修正しました
　(2) GFS_TMODE_SDMA0, GFS_TMODE_SDMA1 を使用してロングワード単位でないデータを
　　　転送するとデータが抜け落ちる障害を修正しました。
　(3) GFS_Loadを使用してファイルの末尾まで読まない場合に、読み込み速度が低下する
　　　障害を改善しました。
********************************* end of file *********************************
